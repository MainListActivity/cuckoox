{"version":3,"file":"BCvqABw0.js","sources":["../../../../node_modules/vuetify/lib/components/VCode/index.mjs","../../../../node_modules/vuetify/lib/components/VForm/VForm.mjs","../../../../pages/signin.vue"],"sourcesContent":["// Styles\nimport \"./VCode.css\";\n\n// Utilities\nimport { createSimpleFunctional } from \"../../util/index.mjs\";\nexport const VCode = createSimpleFunctional('v-code', 'code');\n//# sourceMappingURL=index.mjs.map","import { createVNode as _createVNode } from \"vue\";\n// Composables\nimport { makeComponentProps } from \"../../composables/component.mjs\";\nimport { createForm, makeFormProps } from \"../../composables/form.mjs\";\nimport { forwardRefs } from \"../../composables/forwardRefs.mjs\"; // Utilities\nimport { ref } from 'vue';\nimport { genericComponent, propsFactory, useRender } from \"../../util/index.mjs\"; // Types\nexport const makeVFormProps = propsFactory({\n  ...makeComponentProps(),\n  ...makeFormProps()\n}, 'VForm');\nexport const VForm = genericComponent()({\n  name: 'VForm',\n  props: makeVFormProps(),\n  emits: {\n    'update:modelValue': val => true,\n    submit: e => true\n  },\n  setup(props, _ref) {\n    let {\n      slots,\n      emit\n    } = _ref;\n    const form = createForm(props);\n    const formRef = ref();\n    function onReset(e) {\n      e.preventDefault();\n      form.reset();\n    }\n    function onSubmit(_e) {\n      const e = _e;\n      const ready = form.validate();\n      e.then = ready.then.bind(ready);\n      e.catch = ready.catch.bind(ready);\n      e.finally = ready.finally.bind(ready);\n      emit('submit', e);\n      if (!e.defaultPrevented) {\n        ready.then(_ref2 => {\n          let {\n            valid\n          } = _ref2;\n          if (valid) {\n            formRef.value?.submit();\n          }\n        });\n      }\n      e.preventDefault();\n    }\n    useRender(() => _createVNode(\"form\", {\n      \"ref\": formRef,\n      \"class\": ['v-form', props.class],\n      \"style\": props.style,\n      \"novalidate\": true,\n      \"onReset\": onReset,\n      \"onSubmit\": onSubmit\n    }, [slots.default?.(form)]));\n    return forwardRefs(form, formRef);\n  }\n});\n//# sourceMappingURL=VForm.mjs.map","<template>\n  <div class=\"w-100 h-100 d-flex justify-center align-center\">\n    <v-card title=\"欢迎登录\" variant=\"tonal\" width=\"500\" min-height=\"500\">\n      <v-card-text>\n        <p>请输入您的账号密码并点击确定</p>\n        <v-sheet class=\"mx-auto align-center\">\n          <div\n              :style=\"`background-size: contain;background-position: center;width:100%;height:300px;background-image: url(${loginFormData?.img})`\"\n              class=\"bg-cover bg-center\">\n            <!--            <img src=\"https://m.wbiao.cn/mallapi/wechat/picReverseUrl?url=http://mmbiz.qpic.cn/mmbiz_jpg/GM04hicnQSqv2ICDKicic6N4aTfTpTIo1oLC2iadTvbCEfDwFnDYwDOlyfCDQJE2LJAwt3iaNPwRpJ0OCWicb7KdaR5w/0\"/>-->\n          </div>\n          <div>请扫描上方二维码并在输入框中输入\n            <v-code>{{ loginFormData?.loginId }}</v-code>\n          </div>\n          <v-form v-if=\"route.query['admin']\" fast-fail @submit.prevent=\"submitSignin\">\n            <v-text-field v-model=\"userName\" label=\"用户名\"></v-text-field>\n            <v-text-field :error-messages=\"errorMsg\" v-model=\"password\" label=\"密码\"\n                          type=\"password\"></v-text-field>\n            <v-btn class=\"mt-2\" type=\"submit\" block>确定</v-btn>\n          </v-form>\n          <v-btn class=\"mt-2\" @click=\"submitNewSignin\" block :loading=\"loading\">确定</v-btn>\n        </v-sheet>\n      </v-card-text>\n    </v-card>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport {StringRecordId, Surreal} from \"surrealdb\";\nimport type {User} from \"~/types\";\n\ndeclare type LoginData = {\n  img: string,\n  loginId: string,\n  loginType: \"text\" | \"qr\",\n}\n\ndefinePageMeta({\n  layout: 'public'\n})\nonMounted(() => {\n  // const token='eyJhbGciOiJSUzI1NiIsImtpZCI6ImVyc3dzbWF2ZjYxYXg2ZTQ3MnB0In0.eyJhYyI6Im15dG9rZW4iLCJhdWQiOiJjbGllbnQtY3Vja29veCIsImRiIjoidGVzdCIsImV4cCI6MTczNDQxNTA3NywiaWQiOiJ1c2VyOmtxeGxpZHdqdDV3YW5hZnFsb3piIiwiaXNzIjoiY3Vja29veC5jbiIsIm5zIjoidGVzdCIsInBvbGljeSI6InJlYWR3cml0ZSIsInN1YiI6InVzZXI6a3F4bGlkd2p0NXdhbmFmcWxvemIifQ.A0ikRcyIUqT8dJcFRc8Y1wxVDQqMsa-k227HeTHk-9MDzOk5dbrcNRN14JhnYUNMbPMSSNPEBrDDfs6E5ihZdMw_g5eL1cBPk59DdTiZJ_x71LwQ5xu39IatwLssj2Mnoo0XzHcQ5hHVmDpDSq8pboDXLyr_HzDusrAl7cdMENcG3kr9qOY7MPO9nipJ_f0PsoRlBNUZlI1X68_1szUh1V5wRew4bIsp5aeu7Sqtk55THfa11972j02X9jSuz448yqasOiEAA7fBr3ARmv2y1zyEZXJBl_Xbzi2rL7pVNFdj7V3jzzGWtGTn1yZbqjn-Bsi43mGr6oB3m9rnxkLg4A';\n  // successLogin(token);\n})\nconst errorMsg = ref<string>('');\nconst loginFormData = ref<LoginData>({\n  img: \"http://mmbiz.qpic.cn/mmbiz_jpg/GM04hicnQSqv2ICDKicic6N4aTfTpTIo1oLC2iadTvbCEfDwFnDYwDOlyfCDQJE2LJAwt3iaNPwRpJ0OCWicb7KdaR5w/0\",\n  loginId: \"\",\n  loginType: 'text'\n});\nconst loading = ref<boolean>(false);\nconst router = useRouter();\nconst route = useRoute();\nconst submitNewSignin = async () => {\n  const event = new EventSource(\"https://api.cuckoox.cn/wx/signin\",);\n  loading.value = true;\n  event.onmessage = async (e) => {\n    if (e.data.startsWith('token:')) {\n      // 登录成功\n      await successLogin(e.data.substring('token:'.length));\n      event.close()\n    } else if (e.data.startsWith('loginForm:')) {\n      //页面展示内容\n      const o = JSON.parse(e.data.substring('loginForm:'.length));\n      loginFormData.value = {...o, img: \"https://m.wbiao.cn/mallapi/wechat/picReverseUrl?url=\" + o.img};\n    } else {\n      event.close()\n    }\n  };\n  event.onerror = (err) => {\n    event.close();\n  }\n}\nconst successLogin = async (token: any) => {\n\n  //保存token，初始化db\n  useCurrentUser().value = {token: token};\n  const db = await useApp().value;\n  //登录成功，跳转\n  if (db) {\n    //查询用户信息\n    let session = await db.query(\"select * from $token\");\n    if (!session[0][0]) {\n      //未登录，需要进行认证\n      await db.authenticate(token);\n      session = await db.query(\"select * from $token\");\n    }\n    const user = await db.select<User>(new StringRecordId(session[0][0].ID)) || {\n      userName: session[0][0].ID,\n      avatar: \"admin\"\n    };\n    user.token = token;\n    useCurrentUser().value = user;\n    backHome(db);\n  }\n}\n\nasync function backHome(db: Surreal) {\n  router.push({path: '/'});\n}\n\n\n//管理员相关\nconst userName = ref<string>('');\nconst password = ref<string>('');\n\nconst submitSignin = async () => {\n  // Authenticate with a Database user\n  useCurrentUser().value = {\n    namespace: \"test\",\n    database: \"test\",\n    auth: {username: userName.value, password: password.value}\n  };\n  const db = await useApp().value;\n  if (!db) {\n    return\n  }\n  loading.value = true;\n  //登录成功，跳转\n  backHome(db);\n}\n</script>"],"names":["VCode","createSimpleFunctional","makeVFormProps","propsFactory","makeComponentProps","makeFormProps","VForm","genericComponent","val","e","props","_ref","slots","emit","form","createForm","formRef","ref","onReset","onSubmit","_e","ready","_ref2","valid","_a","useRender","_createVNode","forwardRefs","onMounted","errorMsg","loginFormData","loading","router","useRouter","route","useRoute","submitNewSignin","event","successLogin","o","err","token","useCurrentUser","db","useApp","session","user","StringRecordId","backHome","userName","password","submitSignin"],"mappings":"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","x_google_ignoreList":[0,1]}